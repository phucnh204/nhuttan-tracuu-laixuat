name: Deploy FE UI to Server

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p 24700 ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Sync source code
        run: |
          rsync -avz --delete \
            --exclude=node_modules \
            --exclude=.next \
            --exclude=.git \
            -e "ssh -p 24700" \
            ./fe/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/home/deploy/apps/nhuttan-tracuu-laixuat/fe/

      - name: Build & Restart on server
        run: |
          ssh -p 24700 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd /home/deploy/apps/nhuttan-tracuu-laixuat/fe

            echo "ðŸ§¹ Clean old build..."
            rm -rf .next

            echo "ðŸ“¦ Install deps..."
            npm ci

            echo "ðŸ—ï¸ Build Next.js..."
            npm run build

            echo "â™»ï¸ Restart PM2..."
            pm2 delete camdonhuttan || true
            pm2 start "npx next start -p 3002" --name camdonhuttan
            pm2 save

            echo "âœ… Deploy done"
            pm2 list
          EOF
